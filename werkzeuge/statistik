#!/usr/bin/perl -Wn --

BEGIN
{
    $BOTS=qr/^(Googlebot-Image\/|htdig|egothor|(msn|schibstedsok|Seek|ps|IRL|Exa|e-SocietyRo|MJ12)bot)|(Yahoo! Slurp)|Googlebot|MAINSEEK_BOT|ZyBorg\//;
    if ( defined($ARGV[1]) )
    {
        open ("-", "<", $ARGV[1]) or die "couldn't open logfile";
    }
    our (%PDF_ACCESS, %PDF_UNI_ACCESS, %PDF_GOOGLE_ACCESS, $FIRST_DATE, $LAST_DATE);
    our (%PS_ACCESS, %PS_UNI_ACCESS, %PS_GOOGLE_ACCESS);
    our (%TGZ_ACCESS, %TGZ_UNI_ACCESS, %TGZ_GOOGLE_ACCESS);
}
END
{
    print "Auswertung vom $FIRST_DATE bis zum $LAST_DATE\n\n".
          "PDF-Version\n".
          "Skript                   : Anzahl  aus Uni  über Google\n";
    foreach (sort { $PDF_ACCESS{$b} <=> $PDF_ACCESS{$a} } keys %PDF_ACCESS)
    {
        printf "%-25s: %4d  %8d  %11d\n", $_, $PDF_ACCESS{$_},
          (defined $PDF_UNI_ACCESS{$_})?$PDF_UNI_ACCESS{$_}:0,
          (defined $PDF_GOOGLE_ACCESS{$_})?$PDF_GOOGLE_ACCESS{$_}:0;
    }

    print "\nPostScript-Version\n".
          "Skript                   : Anzahl  aus Uni  über Google\n";
    foreach (sort { $PS_ACCESS{$b} <=> $PS_ACCESS{$a} } keys %PS_ACCESS)
    {
        printf "%-25s: %4d  %8d  %11d\n", $_, $PS_ACCESS{$_},
          (defined $PS_UNI_ACCESS{$_})?$PS_UNI_ACCESS{$_}:0,
          (defined $PS_GOOGLE_ACCESS{$_})?$PS_GOOGLE_ACCESS{$_}:0;
    }

    print "\nQuellen tar.gz\n".
          "Skript                   : Anzahl  aus Uni  über Google\n";
    foreach (sort { $TGZ_ACCESS{$b} <=> $TGZ_ACCESS{$a} } keys %TGZ_ACCESS)
    {
        printf "%-25s: %4d  %8d  %11d\n", $_, $TGZ_ACCESS{$_},
          (defined $TGZ_UNI_ACCESS{$_})?$TGZ_UNI_ACCESS{$_}:0,
          (defined $TGZ_GOOGLE_ACCESS{$_})?$TGZ_GOOGLE_ACCESS{$_}:0;
    }
}

next if ($_ eq "\n");

unless (/([\d.]*) - - \[([^\]]*)\] "([A-Z]*) ([^ ]*) HTTP\/1\.\d" (\d*) (\d*|-) "([^ ]*)" "(.*)"/)
{
    print "could not parse line $.: $_\n";
    next;
}

my ($ip, $date, $method, $url, $ret_code, $size, $referer, $agent) =
    ($1, $2, $3, $4, $5, $6, $7, $8);

$FIRST_DATE = $date unless ( defined $FIRST_DATE );
$LAST_DATE = $date;

next unless ($url =~ /\/~joergs\/skripte\// and $method eq "GET" and
             $ret_code eq "200");

next if ($agent =~ /$BOTS/);
print "bot line: $_\n" if ($agent =~ /bot/i);

if ($url =~ /\/([^\/]*)\.pdf$/)
{
    my $skript = $1;
    ++$PDF_ACCESS{$skript};
    ++$PDF_UNI_ACCESS{$skript} if ($ip =~ /^141\.35\./);
    ++$PDF_GOOGLE_ACCESS{$skript} if ($referer =~ /^http:\/\/www\.google/);
}

if ($url =~ /\/([^\/]*)\.ps$/)
{
    my $skript = $1;
    ++$PS_ACCESS{$skript};
    ++$PS_UNI_ACCESS{$skript} if ($ip =~ /^141\.35\./);
    ++$PS_GOOGLE_ACCESS{$skript} if ($referer =~ /^http:\/\/www\.google/);
}

if ($url =~ /\/([^\/]*)\.tar.gz$/)
{
    my $skript = $1;
    ++$TGZ_ACCESS{$skript};
    ++$TGZ_UNI_ACCESS{$skript} if ($ip =~ /^141\.35\./);
    ++$TGZ_GOOGLE_ACCESS{$skript} if ($referer =~ /^http:\/\/www\.google/);
}

# print "$_\n" foreach ($ip, $date, $method, $url, $ret_code, $size, $referer, $agent);
# print "\n";
